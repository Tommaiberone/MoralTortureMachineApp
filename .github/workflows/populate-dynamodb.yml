name: Populate DynamoDB with Dilemmas

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "yes" to confirm population (will overwrite existing data)'
        required: true
        type: string

env:
  AWS_REGION: eu-west-1
  PYTHON_VERSION: '3.11'
  DYNAMODB_TABLE_NAME: moral-torture-machine-dilemmas

jobs:
  populate:
    name: Populate DynamoDB
    runs-on: ubuntu-latest
    
    steps:
      - name: Validate confirmation
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "yes" ]; then
            echo "‚ùå You must type 'yes' to confirm the operation"
            exit 1
          fi

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install boto3
        run: pip install boto3

      - name: Check dilemma files
        working-directory: backend
        run: |
          echo "üìã Checking dilemma files..."
          if [ ! -f "dilemmas.json" ]; then
            echo "‚ùå Error: dilemmas.json not found!"
            exit 1
          fi
          if [ ! -f "dilemmas_it.json" ]; then
            echo "‚ùå Error: dilemmas_it.json not found!"
            exit 1
          fi
          
          en_count=$(jq '. | length' dilemmas.json)
          it_count=$(jq '. | length' dilemmas_it.json)
          
          echo "‚úÖ Found $en_count English dilemmas"
          echo "‚úÖ Found $it_count Italian dilemmas"

      - name: Backup current DynamoDB data
        run: |
          echo "üíæ Creating backup of current DynamoDB data..."
          timestamp=$(date +%Y%m%d-%H%M%S)
          backup_name="backup-$timestamp"
          
          aws dynamodb create-backup \
            --table-name ${{ env.DYNAMODB_TABLE_NAME }} \
            --backup-name "$backup_name" \
            --region ${{ env.AWS_REGION }}
          
          echo "‚úÖ Backup created: $backup_name"

      - name: Populate DynamoDB
        working-directory: backend
        run: |
          echo "üìä Populating DynamoDB table: ${{ env.DYNAMODB_TABLE_NAME }}"
          python3 -u populate_dynamodb_multilang.py ${{ env.DYNAMODB_TABLE_NAME }} <<EOF
          yes
          EOF

      - name: Verify population
        run: |
          echo "üîç Verifying DynamoDB content..."
          
          # Get total count
          total_count=$(aws dynamodb describe-table \
            --table-name ${{ env.DYNAMODB_TABLE_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --query 'Table.ItemCount' \
            --output text)
          
          echo "üìä Total items in table: $total_count"
          
          # Count items per language
          en_count=$(aws dynamodb scan \
            --table-name ${{ env.DYNAMODB_TABLE_NAME }} \
            --filter-expression "attribute_exists(#lang) AND #lang = :lang" \
            --expression-attribute-names '{"#lang": "language"}' \
            --expression-attribute-values '{":lang": {"S": "en"}}' \
            --select COUNT \
            --region ${{ env.AWS_REGION }} \
            --query 'Count' \
            --output text)
          
          it_count=$(aws dynamodb scan \
            --table-name ${{ env.DYNAMODB_TABLE_NAME }} \
            --filter-expression "attribute_exists(#lang) AND #lang = :lang" \
            --expression-attribute-names '{"#lang": "language"}' \
            --expression-attribute-values '{":lang": {"S": "it"}}' \
            --select COUNT \
            --region ${{ env.AWS_REGION }} \
            --query 'Count' \
            --output text)
          
          echo "‚úÖ English dilemmas: $en_count"
          echo "‚úÖ Italian dilemmas: $it_count"
          
          if [ "$total_count" -eq 0 ]; then
            echo "‚ùå Error: No items in DynamoDB table!"
            exit 1
          fi
          
          echo "‚úÖ DynamoDB population verified!"

      - name: Test API with populated data
        run: |
          echo "üß™ Testing API with new data..."
          API_URL="https://wxe53u88o8.execute-api.eu-west-1.amazonaws.com"
          
          echo "Testing English endpoint..."
          response=$(curl -s "$API_URL/get-dilemma?language=en")
          if echo "$response" | jq -e '._id' > /dev/null; then
            echo "‚úÖ English dilemmas working"
            echo "Sample ID: $(echo "$response" | jq -r '._id')"
          else
            echo "‚ùå English dilemmas not working"
            echo "$response"
            exit 1
          fi
          
          echo "Testing Italian endpoint..."
          response=$(curl -s "$API_URL/get-dilemma?language=it")
          if echo "$response" | jq -e '._id' > /dev/null; then
            echo "‚úÖ Italian dilemmas working"
            echo "Sample ID: $(echo "$response" | jq -r '._id')"
          else
            echo "‚ùå Italian dilemmas not working"
            echo "$response"
            exit 1
          fi
          
          echo "‚úÖ All API tests passed!"

      - name: Summary
        if: always()
        run: |
          echo "=================================="
          echo "üìä DynamoDB Population Summary"
          echo "=================================="
          echo "Table: ${{ env.DYNAMODB_TABLE_NAME }}"
          echo "Region: ${{ env.AWS_REGION }}"
          echo ""
          echo "Status: ${{ job.status }}"
          echo ""
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ DynamoDB populated successfully!"
            echo "üåê API is ready to use"
          else
            echo "‚ùå Population failed - check logs above"
          fi
