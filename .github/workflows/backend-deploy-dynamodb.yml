name: Deploy Backend to Lambda with DynamoDB

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/backend-deploy-dynamodb.yml'
  workflow_dispatch:
    inputs:
      populate_dynamodb:
        description: 'Populate DynamoDB with fresh data'
        required: false
        default: false
        type: boolean

env:
  AWS_REGION: eu-west-1
  PYTHON_VERSION: '3.11'
  LAMBDA_FUNCTION_NAME: moral-torture-machine-backend
  DYNAMODB_TABLE_NAME: moral-torture-machine-dilemmas

jobs:
  build-and-deploy:
    name: Build and Deploy Backend
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install dependencies in lambda_deployment
        working-directory: backend/lambda_deployment
        run: |
          echo "ðŸ“¦ Installing Python dependencies..."
          pip install --target . -r ../requirements.txt --upgrade

      - name: Copy backend code to lambda_deployment
        working-directory: backend
        run: |
          echo "ðŸ“‹ Copying backend_fastapi.py to lambda_deployment..."
          cp backend_fastapi.py lambda_deployment/

      - name: Create Lambda deployment package
        working-directory: backend/lambda_deployment
        run: |
          echo "ðŸ—œï¸  Creating Lambda ZIP package..."
          zip -r ../lambda_function.zip . -x "*.pyc" -x "__pycache__/*" -x "*/__pycache__/*" -x "*.json"
          cd ..
          echo "âœ… Lambda package size:"
          ls -lh lambda_function.zip

      - name: Deploy to Lambda
        working-directory: backend
        run: |
          echo "â˜ï¸  Deploying to Lambda function: ${{ env.LAMBDA_FUNCTION_NAME }}"
          aws lambda update-function-code \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --zip-file fileb://lambda_function.zip \
            --region ${{ env.AWS_REGION }}
          
          echo "â³ Waiting for Lambda to be ready..."
          aws lambda wait function-updated \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --region ${{ env.AWS_REGION }}
          
          echo "âœ… Lambda deployed successfully!"

      - name: Test API endpoints
        run: |
          echo "ðŸ§ª Testing API endpoints..."
          API_URL="https://wxe53u88o8.execute-api.eu-west-1.amazonaws.com"
          
          echo "Test 1: Health check"
          curl -f "$API_URL/" || exit 1
          
          echo "Test 2: Get English dilemma"
          response=$(curl -s "$API_URL/get-dilemma?language=en")
          echo "$response" | jq -e '._id' > /dev/null || exit 1
          
          echo "Test 3: Get Italian dilemma"
          response=$(curl -s "$API_URL/get-dilemma?language=it")
          echo "$response" | jq -e '._id' > /dev/null || exit 1
          
          echo "âœ… All tests passed!"

  populate-dynamodb:
    name: Populate DynamoDB
    runs-on: ubuntu-latest
    if: github.event.inputs.populate_dynamodb == 'true' || (github.event_name == 'push' && contains(github.event.head_commit.message, '[populate-db]'))
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install boto3
        run: pip install boto3

      - name: Populate DynamoDB
        working-directory: backend
        run: |
          echo "ðŸ“Š Populating DynamoDB table: ${{ env.DYNAMODB_TABLE_NAME }}"
          python3 populate_dynamodb_multilang.py ${{ env.DYNAMODB_TABLE_NAME }} <<EOF
          yes
          EOF
          echo "âœ… DynamoDB populated successfully!"

      - name: Verify DynamoDB content
        run: |
          echo "ðŸ” Verifying DynamoDB content..."
          item_count=$(aws dynamodb describe-table \
            --table-name ${{ env.DYNAMODB_TABLE_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --query 'Table.ItemCount' \
            --output text)
          
          echo "ðŸ“Š Total items in table: $item_count"
          
          if [ "$item_count" -eq 0 ]; then
            echo "âŒ Error: No items in DynamoDB table!"
            exit 1
          fi
          
          echo "âœ… DynamoDB verification passed!"

  notify:
    name: Notify Deployment
    runs-on: ubuntu-latest
    needs: [build-and-deploy]
    if: always()
    
    steps:
      - name: Deployment Status
        run: |
          if [ "${{ needs.build-and-deploy.result }}" == "success" ]; then
            echo "âœ… Backend deployed successfully!"
            echo "ðŸŒ API URL: https://wxe53u88o8.execute-api.eu-west-1.amazonaws.com"
          else
            echo "âŒ Backend deployment failed!"
            exit 1
          fi
